<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Van Vleck ISD - Technology Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
</head>
<body class="bg-gray-50">

  <script>
    // Check if the user is logged in. If not, redirect to the Flask server's login route.
    // The Flask server will handle the Google SSO process and only serve the full
    // application content upon successful authentication.
    if (!document.cookie.includes('session')) {
      // Assuming the Flask server is on the same domain, redirect to the login route.
      // The Flask server will handle the redirect to Google's OAuth endpoint.
      window.location.href = '/login';
    }
  </script>

  <div id="app"></div>

  <script>
    // Refactored into a modular IIFE to prevent global namespace pollution
    (function() {

    // State management
    let state = {
      items: JSON.parse(localStorage.getItem('techInventory') || '[]'),
      sites: [],
      rooms: [],
      sheetsUrl: localStorage.getItem('sheetsUrl') || '',
      dellApiUrl: 'https://YOUR_DEPLOYED_API_URL', // Placeholder - MUST be updated by user

      searchTerm: '',
      currentView: 'inventory',
      showAddModal: false,
      showScanner: false,
      showClassroomsOnly: true,
      editingItem: null,
      scannerActive: false,
      codeReader: null,
      videoStream: null,
      formData: {
        name: '',
        barcode: '',
        category: 'Desktop',
        site: '',
        room: '',
        status: 'Available',
        assignedTo: '',
        purchaseDate: ''
      }
    };

    const categories = ['Desktop', 'TV', 'Laptop', 'Tablet', 'Printer', 'Switch', 'Server', 'UPS', 'Other'];
    const statuses = ['Available', 'In Use', 'In Repair', 'Retired'];

    // Utility functions

    function debounce(func, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
          func.apply(this, args);
        }, delay);
      };
    }
    function isValidDellServiceTag(code) {
      // Dell service tags are 7-character alphanumeric (A-Z, 0-9)
      return /^[a-zA-Z0-9]{7}$/.test(code.toUpperCase());
    }

    function isValidHPSerial(code) {
      // HP serial numbers are typically 10 to 12 alphanumeric characters
      return /^[a-zA-Z0-9]{10,12}$/.test(code.toUpperCase());
    }

    function isValidViewSonicSerial(code) {
      // ViewSonic serial numbers are typically 10 to 12 alphanumeric characters
      return /^[a-zA-Z0-9]{10,12}$/.test(code.toUpperCase());
    }

    function isValidJuniperSerial(code) {
      // Juniper serial numbers are typically 12 alphanumeric characters
      return /^[a-zA-Z0-9]{12}$/.test(code.toUpperCase());
    }

    function isValidBrotherSerial(code) {
      // Brother serial numbers are typically 15 alphanumeric characters
      return /^[a-zA-Z0-9]{15}$/.test(code.toUpperCase());
    }

    function isValidAppleSerial(code) {
      // Apple serial numbers are 12 or 17 alphanumeric characters
      return /^[a-zA-Z0-9]{12}$|^[a-zA-Z0-9]{17}$/.test(code.toUpperCase());
    }

    function isValidAcerSerial(code) {
      // Acer serial numbers are 22 alphanumeric characters or 11/12 digit SNID
      return /^[a-zA-Z0-9]{22}$|^\d{11,12}$/.test(code.toUpperCase());
    }

    function isValidCyberPowerSerial(code) {
      // CyberPower serial numbers are typically 12 or 16 alphanumeric characters
      return /^[a-zA-Z0-9]{12}$|^[a-zA-Z0-9]{16}$/.test(code.toUpperCase());
    }

    function isValidMicrosoftSerial(code) {
      // Microsoft serial numbers are typically 12 or 16 digits/letters
      return /^[a-zA-Z0-9]{12}$|^[a-zA-Z0-9]{16}$/.test(code.toUpperCase());
    }

    function isValidLenovoSerial(code) {
      // Lenovo serial numbers are typically 7 to 10 alphanumeric characters
      return /^[a-zA-Z0-9]{7,10}$/.test(code.toUpperCase());
    }

    function isValidCiscoSerial(code) {
      // Cisco serial numbers are typically 11 alphanumeric characters
      return /^[a-zA-Z0-9]{11}$/.test(code.toUpperCase());
    }

    function isValidAPCSerial(code) {
      // APC serial numbers are typically 13 alphanumeric characters
      return /^[a-zA-Z0-9]{13}$/.test(code.toUpperCase());
    }

    function isValidSamsungSerial(code) {
      // Samsung serial numbers are typically 15 alphanumeric characters
      return /^[a-zA-Z0-9]{15}$/.test(code.toUpperCase());
    }

    function isValidVizioSerial(code) {
      // Vizio serial numbers are typically 14 alphanumeric characters
      return /^[a-zA-Z0-9]{14}$/.test(code.toUpperCase());
    }

    function isValidTCLSerial(code) {
      // TCL serial numbers are typically 14 alphanumeric characters
      return /^[a-zA-Z0-9]{14}$/.test(code.toUpperCase());
    }

    function isClassroom(roomNumber) {
      const room = roomNumber.includes(' - ') ? roomNumber.split(' - ')[1] : roomNumber;
      const excludeKeywords = [
        'RESTROOM', 'RR', 'STORAGE', 'CUSTODIAL', 'MECHANICAL', 'ELECTRICAL',
        'IDF', 'MDF', 'CORRIDOR', 'OFFICE', 'CLINIC', 'KITCHEN', 'VESTIBULE',
        'STAIR', 'ELEVATOR', 'FIRE RISER', 'BOILER', 'RECEPTION', 'ATTENDANCE',
        'WORKROOM', 'ISS', 'RECORDS', 'SERVICE YARD', 'ENTRY', 'MAIN STREET',
        'CIRCULATION', 'LOUNGE', 'CHAIR STORAGE', 'GYM STORAGE', 'LOCKERS'
      ];
      const roomUpper = room.toUpperCase();
      return !excludeKeywords.some(keyword => roomUpper.includes(keyword));
    }

    function getFilteredRooms() {
      if (!state.formData.site) return [];
      let filteredRooms = state.rooms.filter(room => room.startsWith(state.formData.site + ' - '));
      if (state.showClassroomsOnly) {
        filteredRooms = filteredRooms.filter(room => isClassroom(room));
      }
      return filteredRooms.map(room => room.replace(state.formData.site + ' - ', ''));
    }

    function formatDateTime(isoString) {
      if (!isoString) return 'N/A';
      const date = new Date(isoString);
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    }

    async function lookupDellModel(serviceTag) {
      if (!serviceTag || !isValidDellServiceTag(serviceTag)) return;

      const apiURL = state.dellApiUrl + '/lookup/dell?tag=' + serviceTag;
      
      showMessage('Looking up Dell model for ' + serviceTag + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Dell Model: ' + data.model_name, 'success');
          render();
        } else {
          showMessage('Dell lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Dell API Lookup Error:', error);
        showMessage('Could not connect to Dell Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupMicrosoftModel(serialNumber) {
      if (!serialNumber || !isValidMicrosoftSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/microsoft?tag=' + serialNumber;
      
      showMessage('Looking up Microsoft model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Microsoft Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('Microsoft lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Microsoft API Lookup Error:', error);
        showMessage('Could not connect to Microsoft Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupAPCModel(serialNumber) {
      if (!serialNumber || !isValidAPCSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/apc?tag=' + serialNumber;
      
      showMessage('Looking up APC model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found APC Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('APC lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('APC API Lookup Error:', error);
        showMessage('Could not connect to APC Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupCiscoModel(serialNumber) {
      if (!serialNumber || !isValidCiscoSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/cisco?tag=' + serialNumber;
      
      showMessage('Looking up Cisco model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Cisco Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('Cisco lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Cisco API Lookup Error:', error);
        showMessage('Could not connect to Cisco Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupLenovoModel(serialNumber) {
      if (!serialNumber || !isValidLenovoSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/lenovo?tag=' + serialNumber;
      
      showMessage('Looking up Lenovo model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Lenovo Model: ' + data.model_name, 'success');
          render();
        } else {
          showMessage('Lenovo lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Lenovo API Lookup Error:', error);
        showMessage('Could not connect to Lenovo Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupAcerModel(serialNumber) {
      if (!serialNumber || !isValidAcerSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/acer?tag=' + serialNumber;
      
      showMessage('Looking up Acer model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Acer Model: ' + data.model_name, 'success');
          render();
        } else {
          showMessage('Acer lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Acer API Lookup Error:', error);
        showMessage('Could not connect to Acer Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupAppleModel(serialNumber) {
      if (!serialNumber || !isValidAppleSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/apple?tag=' + serialNumber;
      
      showMessage('Looking up Apple model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Apple Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('Apple lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Apple API Lookup Error:', error);
        showMessage('Could not connect to Apple Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupBrotherModel(serialNumber) {
      if (!serialNumber || !isValidBrotherSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/brother?tag=' + serialNumber;
      
      showMessage('Looking up Brother model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Brother Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('Brother lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Brother API Lookup Error:', error);
        showMessage('Could not connect to Brother Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupCyberPowerModel(serialNumber) {
      if (!serialNumber || !isValidCyberPowerSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/cyberpower?tag=' + serialNumber;
      
      showMessage('Looking up CyberPower model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found CyberPower Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('CyberPower lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('CyberPower API Lookup Error:', error);
        showMessage('Could not connect to CyberPower Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupJuniperModel(serialNumber) {
      if (!serialNumber || !isValidJuniperSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/juniper?tag=' + serialNumber;
      
      showMessage('Looking up Juniper model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Juniper Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('Juniper lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Juniper API Lookup Error:', error);
        showMessage('Could not connect to Juniper Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupViewSonicModel(serialNumber) {
      if (!serialNumber || !isValidViewSonicSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/viewsonic?tag=' + serialNumber;
      
      showMessage('Looking up ViewSonic model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found ViewSonic Model: ' + data.model_name, 'success');
          render();
        } else {
          showMessage('ViewSonic lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('ViewSonic API Lookup Error:', error);
        showMessage('Could not connect to ViewSonic Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupHPModel(serialNumber) {
      if (!serialNumber || !isValidHPSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/hp?tag=' + serialNumber;
      
      showMessage('Looking up HP model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found HP Model: ' + data.model_name, 'success');
          render();
        } else {
          showMessage('HP lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('HP API Lookup Error:', error);
        showMessage('Could not connect to HP Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupSamsungModel(serialNumber) {
      if (!serialNumber || !isValidSamsungSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/samsung?tag=' + serialNumber;
      
      showMessage('Looking up Samsung model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Samsung Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('Samsung lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Samsung API Lookup Error:', error);
        showMessage('Could not connect to Samsung Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupVizioModel(serialNumber) {
      if (!serialNumber || !isValidVizioSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/vizio?tag=' + serialNumber;
      
      showMessage('Looking up Vizio model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Vizio Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('Vizio lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Vizio API Lookup Error:', error);
        showMessage('Could not connect to Vizio Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupTCLModel(serialNumber) {
      if (!serialNumber || !isValidTCLSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/tcl?tag=' + serialNumber;
      
      showMessage('Looking up TCL model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found TCL Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('TCL lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('TCL API Lookup Error:', error);
        showMessage('Could not connect to TCL Lookup API. Check your API URL in settings.', 'error');
      }
    }

    function showMessage(message, type = 'success') {
      // Implementation of showMessage function...
    }

    function syncToSheets() {
      // Implementation of syncToSheets function...
    }

    async function loadFromSheets() {
      // Implementation of loadFromSheets function...
    }

    function addItem() {
      // Implementation of addItem function...
    }

    function editItem() {
      // Implementation of editItem function...
    }

    function deleteItem(id) {
      // Implementation of deleteItem function...
    }

    function openEditModal(item) {
      // Implementation of openEditModal function...
    }

    function resetForm() {
      // Implementation of resetForm function...
    }

    function saveSettings() {
      // Implementation of saveSettings function...
    }

    function render() {
      // Implementation of render function...
    }

    function renderInventoryView(filteredItems) {
      // Implementation of renderInventoryView function...
    }

    function renderSettingsView() {
      // Implementation of renderSettingsView function...
    }

    function renderScannerModal() {
      // Implementation of renderScannerModal function...
    }

    function renderAddModal() {
      // Implementation of renderAddModal function...
    }

    function changeView(view) {
      // Implementation of changeView function...
    }

    function loadFromSheets() {
      // Implementation of loadFromSheets function...
    }

    // Item operations
    function addItem() {
      // Implementation of addItem function...
    }

    function editItem() {
      // Implementation of editItem function...
    }

    function deleteItem(id) {
      // Implementation of deleteItem function...
    }

    function openEditModal(item) {
      // Implementation of openEditModal function...
    }

    function resetForm() {
      // Implementation of resetForm function...
    }

    function saveSettings() {
      // Implementation of saveSettings function...
    }

    function render() {
      // Implementation of render function...
    }

    function renderInventoryView(filteredItems) {
      // Implementation of renderInventoryView function...
    }

    function renderSettingsView() {
      // Implementation of renderSettingsView function...
    }

    function renderScannerModal() {
      // Implementation of renderScannerModal function...
    }

    function renderAddModal() {
      // Implementation of renderAddModal function...
    }

    function changeView(view) {
      // Implementation of changeView function...
    }

    function loadFromSheets() {
      // Implementation of loadFromSheets function...
    }

    // Load saved URL and data on startup
    if (state.sheetsUrl) {
      loadFromSheets();
    }

    // Initial render
    render();

    // Debounce the render function for search input
    const debouncedRender = debounce((value) => {
      state.searchTerm = value;
      render();
    }, 300);

    // Expose necessary functions to the global scope for HTML event handlers
    window.changeView = changeView;
    window.loadFromSheets = loadFromSheets;
    window.startCameraScanner = startCameraScanner;
    window.resetForm = resetForm;
    window.render = render;
    window.debouncedRender = debouncedRender;
    window.openEditModal = openEditModal;
    window.deleteItem = deleteItem;
    window.saveSettings = saveSettings;
    window.closeScannerModal = closeScannerModal;
    window.addItem = addItem;
    window.editItem = editItem;
    window.isValidDellServiceTag = isValidDellServiceTag; // Exposed for manual entry logic
    window.isValidHPSerial = isValidHPSerial; // Exposed for manual entry logic
    window.isValidViewSonicSerial = isValidViewSonicSerial; // Exposed for manual entry logic
    window.isValidJuniperSerial = isValidJuniperSerial; // Exposed for manual entry logic
    window.isValidCyberPowerSerial = isValidCyberPowerSerial; // Exposed for manual entry logic
    window.isValidBrotherSerial = isValidBrotherSerial; // Exposed for manual entry logic
    window.isValidAppleSerial = isValidAppleSerial; // Exposed for manual entry logic
    window.isValidAcerSerial = isValidAcerSerial; // Exposed for manual entry logic
    window.isValidLenovoSerial = isValidLenovoSerial; // Exposed for manual entry logic
    window.isValidCiscoSerial = isValidCiscoSerial; // Exposed for manual entry logic
    window.isValidAPCSerial = isValidAPCSerial; // Exposed for manual entry logic
    window.isValidMicrosoftSerial = isValidMicrosoftSerial; // Exposed for manual entry logic
    window.isValidSamsungSerial = isValidSamsungSerial; // Exposed for manual entry logic
    window.isValidVizioSerial = isValidVizioSerial; // Exposed for manual entry logic
    window.isValidTCLSerial = isValidTCLSerial; // Exposed for manual entry logic
    window.lookupDellModel = lookupDellModel;
    window.lookupHPModel = lookupHPModel;
    window.lookupViewSonicModel = lookupViewSonicModel;
    window.lookupJuniperModel = lookupJuniperModel;
    window.lookupCyberPowerModel = lookupCyberPowerModel;
    window.lookupBrotherModel = lookupBrotherModel;
    window.lookupAppleModel = lookupAppleModel;
    window.lookupAcerModel = lookupAcerModel;
    window.lookupLenovoModel = lookupLenovoModel;
    window.lookupCiscoModel = lookupCiscoModel;
    window.lookupAPCModel = lookupAPCModel;
    window.lookupMicrosoftModel = lookupMicrosoftModel;
    window.lookupSamsungModel = lookupSamsungModel;
    window.lookupVizioModel = lookupVizioModel;
    window.lookupTCLModel = lookupTCLModel;

    })();
  </script>
</body>
  <div id="app"></div>

  <script>
    // Refactored into a modular IIFE to prevent global namespace pollution
    (function() {

    // State management
    let state = {
      items: JSON.parse(localStorage.getItem('techInventory') || '[]'),
      sites: [],
      rooms: [],
      sheetsUrl: localStorage.getItem('sheetsUrl') || '',
      dellApiUrl: 'https://YOUR_DEPLOYED_API_URL', // Placeholder - MUST be updated by user

      searchTerm: '',
      currentView: 'inventory',
      showAddModal: false,
      showScanner: false,
      showClassroomsOnly: true,
      editingItem: null,
      scannerActive: false,
      codeReader: null,
      videoStream: null,
      formData: {
        name: '',
        barcode: '',
        category: 'Desktop',
        site: '',
        room: '',
        status: 'Available',
        assignedTo: '',
        purchaseDate: ''
      }
    };

    const categories = ['Desktop', 'TV', 'Laptop', 'Tablet', 'Printer', 'Switch', 'Server', 'UPS', 'Other'];
    const statuses = ['Available', 'In Use', 'In Repair', 'Retired'];

    // Utility functions

    function debounce(func, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
          func.apply(this, args);
        }, delay);
      };
    }
    function isValidDellServiceTag(code) {
      // Dell service tags are 7-character alphanumeric (A-Z, 0-9)
      return /^[a-zA-Z0-9]{7}$/.test(code.toUpperCase());
    }

    function isValidHPSerial(code) {
      // HP serial numbers are typically 10 to 12 alphanumeric characters
      return /^[a-zA-Z0-9]{10,12}$/.test(code.toUpperCase());
    }

    function isValidViewSonicSerial(code) {
      // ViewSonic serial numbers are typically 10 to 12 alphanumeric characters
      return /^[a-zA-Z0-9]{10,12}$/.test(code.toUpperCase());
    }

    function isValidJuniperSerial(code) {
      // Juniper serial numbers are typically 12 alphanumeric characters
      return /^[a-zA-Z0-9]{12}$/.test(code.toUpperCase());
    }

    function isValidBrotherSerial(code) {
      // Brother serial numbers are typically 15 alphanumeric characters
      return /^[a-zA-Z0-9]{15}$/.test(code.toUpperCase());
    }

    function isValidAppleSerial(code) {
      // Apple serial numbers are 12 or 17 alphanumeric characters
      return /^[a-zA-Z0-9]{12}$|^[a-zA-Z0-9]{17}$/.test(code.toUpperCase());
    }

    function isValidAcerSerial(code) {
      // Acer serial numbers are 22 alphanumeric characters or 11/12 digit SNID
      return /^[a-zA-Z0-9]{22}$|^\d{11,12}$/.test(code.toUpperCase());
    }

    function isValidCyberPowerSerial(code) {
      // CyberPower serial numbers are typically 12 or 16 alphanumeric characters
      return /^[a-zA-Z0-9]{12}$|^[a-zA-Z0-9]{16}$/.test(code.toUpperCase());
    }

    function isValidMicrosoftSerial(code) {
      // Microsoft serial numbers are typically 12 or 16 digits/letters
      return /^[a-zA-Z0-9]{12}$|^[a-zA-Z0-9]{16}$/.test(code.toUpperCase());
    }

    function isClassroom(roomNumber) {
      const room = roomNumber.includes(' - ') ? roomNumber.split(' - ')[1] : roomNumber;
      const excludeKeywords = [
        'RESTROOM', 'RR', 'STORAGE', 'CUSTODIAL', 'MECHANICAL', 'ELECTRICAL',
        'IDF', 'MDF', 'CORRIDOR', 'OFFICE', 'CLINIC', 'KITCHEN', 'VESTIBULE',
        'STAIR', 'ELEVATOR', 'FIRE RISER', 'BOILER', 'RECEPTION', 'ATTENDANCE',
        'WORKROOM', 'ISS', 'RECORDS', 'SERVICE YARD', 'ENTRY', 'MAIN STREET',
        'CIRCULATION', 'LOUNGE', 'CHAIR STORAGE', 'GYM STORAGE', 'LOCKERS'
      ];
      const roomUpper = room.toUpperCase();
      return !excludeKeywords.some(keyword => roomUpper.includes(keyword));
    }

    function getFilteredRooms() {
      if (!state.formData.site) return [];
      let filteredRooms = state.rooms.filter(room => room.startsWith(state.formData.site + ' - '));
      if (state.showClassroomsOnly) {
        filteredRooms = filteredRooms.filter(room => isClassroom(room));
      }
      return filteredRooms.map(room => room.replace(state.formData.site + ' - ', ''));
    }

    function formatDateTime(isoString) {
      if (!isoString) return 'N/A';
      const date = new Date(isoString);
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    }

    async function lookupDellModel(serviceTag) {
      if (!serviceTag || !isValidDellServiceTag(serviceTag)) return;

      const apiURL = state.dellApiUrl + '/lookup/dell?tag=' + serviceTag;
      
      showMessage('Looking up Dell model for ' + serviceTag + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Dell Model: ' + data.model_name, 'success');
          render();
        } else {
          showMessage('Dell lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Dell API Lookup Error:', error);
        showMessage('Could not connect to Dell Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupMicrosoftModel(serialNumber) {
      if (!serialNumber || !isValidMicrosoftSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/microsoft?tag=' + serialNumber;
      
      showMessage('Looking up Microsoft model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Microsoft Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('Microsoft lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Microsoft API Lookup Error:', error);
        showMessage('Could not connect to Microsoft Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupAPCModel(serialNumber) {      if (!serialNumber || !isValidHPSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/hp?tag=' + serialNumber;
      
      showMessage('Looking up HP model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found HP Model: ' + data.model_name, 'success');
          render();
        } else {
          showMessage('HP lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('HP API Lookup Error:', error);
        showMessage('Could not connect to HP Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupViewSonicModel(serialNumber) {
      if (!serialNumber || !isValidViewSonicSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/viewsonic?tag=' + serialNumber;
      
      showMessage('Looking up ViewSonic model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found ViewSonic Model: ' + data.model_name, 'success');
          render();
        } else {
          showMessage('ViewSonic lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('ViewSonic API Lookup Error:', error);
        showMessage('Could not connect to ViewSonic Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupJuniperModel(serialNumber) {
      if (!serialNumber || !isValidJuniperSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/juniper?tag=' + serialNumber;
      
      showMessage('Looking up Juniper model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Juniper Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('Juniper lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Juniper API Lookup Error:', error);
        showMessage('Could not connect to Juniper Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupBrotherModel(serialNumber) {
      if (!serialNumber || !isValidBrotherSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/brother?tag=' + serialNumber;
      
      showMessage('Looking up Brother model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Brother Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('Brother lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Brother API Lookup Error:', error);
        showMessage('Could not connect to Brother Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupAcerModel(serialNumber) {
      if (!serialNumber || !isValidAcerSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/acer?tag=' + serialNumber;
      
      showMessage('Looking up Acer model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Acer Model: ' + data.model_name + '. NOTE: Web scraping may be unreliable.', 'success');
          render();
        } else {
          showMessage('Acer lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Acer API Lookup Error:', error);
        showMessage('Could not connect to Acer Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupAppleModel(serialNumber) {
      if (!serialNumber || !isValidAppleSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/apple?tag=' + serialNumber;
      
      showMessage('Looking up Apple model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found Apple Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('Apple lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('Apple API Lookup Error:', error);
        showMessage('Could not connect to Apple Lookup API. Check your API URL in settings.', 'error');
      }
    }

    async function lookupCyberPowerModel(serialNumber) {
      if (!serialNumber || !isValidCyberPowerSerial(serialNumber)) return;

      const apiURL = state.dellApiUrl + '/lookup/cyberpower?tag=' + serialNumber;
      
      showMessage('Looking up CyberPower model for ' + serialNumber + '...', 'info');

      try {
        const response = await fetch(apiURL);
        const data = await response.json();

        if (data.success) {
          state.formData.name = data.model_name;
          showMessage('Found CyberPower Model: ' + data.model_name + '. NOTE: Model is inferred, please verify.', 'success');
          render();
        } else {
          showMessage('CyberPower lookup failed: ' + (data.error || 'Unknown error.'), 'error');
        }
      } catch (error) {
        console.error('CyberPower API Lookup Error:', error);
        showMessage('Could not connect to CyberPower Lookup API. Check your API URL in settings.', 'error');
      }
    }

    function showMessage(message, type = 'success') {
      const msgDiv = document.createElement('div');
      msgDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-100 text-green-800' :
        type === 'error' ? 'bg-red-100 text-red-800' :
        'bg-blue-100 text-blue-800'
      }`;
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      setTimeout(() => msgDiv.remove(), 3000);
    }

    // Camera scanner functions
    async function startCameraScanner() {
      state.showScanner = true;
      state.scannerActive = false;
      render();
      
      // Wait for DOM to be ready
      setTimeout(async () => {
        try {
          const codeReader = new ZXing.BrowserMultiFormatReader();
          state.codeReader = codeReader;
          
          // Get video devices
          const videoInputDevices = await codeReader.listVideoInputDevices();
          
          if (videoInputDevices.length === 0) {
            showMessage('No camera found on this device', 'error');
            return;
          }
          
          // Use back camera if available (for phones)
          let selectedDeviceId = videoInputDevices[0].deviceId;
          for (const device of videoInputDevices) {
            if (device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('rear')) {
              selectedDeviceId = device.deviceId;
              break;
            }
          }
          
          // Start decoding from video device
          state.scannerActive = true;
          codeReader.decodeFromVideoDevice(selectedDeviceId, 'video-preview', (result, err) => {
            if (result) {
              // Barcode scanned successfully!
              const scannedCode = result.text;
              stopCameraScanner();

              const tag = scannedCode.toUpperCase();
              
              if (isValidDellServiceTag(tag)) {
                state.formData.barcode = tag; 
                showMessage('Dell Service Tag scanned: ' + tag);
                lookupDellModel(tag); // <-- New: Lookup Dell model
              } else if (isValidHPSerial(tag)) {
                state.formData.barcode = tag; 
                showMessage('HP Serial Number scanned: ' + tag);
                lookupHPModel(tag); // <-- New: Lookup HP model
              } else if (isValidViewSonicSerial(tag)) {
                state.formData.barcode = tag; 
                showMessage('ViewSonic Serial Number scanned: ' + tag);
                lookupViewSonicModel(tag); // <-- New: Lookup ViewSonic model
              } else if (isValidJuniperSerial(tag)) {
                state.formData.barcode = tag; 
                showMessage('Juniper Serial Number scanned: ' + tag);
                lookupJuniperModel(tag); // <-- New: Lookup Juniper model
              } else if (isValidCyberPowerSerial(tag)) {
                state.formData.barcode = tag; 
                showMessage('CyberPower Serial Number scanned: ' + tag);
                lookupCyberPowerModel(tag); // <-- New: Lookup CyberPower model
              } else if (isValidMicrosoftSerial(tag)) {
                state.formData.barcode = tag; 
                showMessage('Microsoft Serial Number scanned: ' + tag);
                lookupMicrosoftModel(tag); // <-- New: Lookup Microsoft model
              } else if (isValidSamsungSerial(tag)) {
                state.formData.barcode = tag; 
                showMessage('Samsung Serial Number scanned: ' + tag);
                lookupSamsungModel(tag); // <-- New: Lookup Samsung model
              } else if (isValidVizioSerial(tag)) {
                state.formData.barcode = tag; 
                showMessage('Vizio Serial Number scanned: ' + tag);
                lookupVizioModel(tag); // <-- New: Lookup Vizio model
              } else if (isValidTCLSerial(tag)) {
                state.formData.barcode = tag; 
                showMessage('TCL Serial Number scanned: ' + tag);
                lookupTCLModel(tag); // <-- New: Lookup TCL model
              } else {
                state.formData.barcode = scannedCode;
                showMessage('Barcode scanned: ' + scannedCode);
              }

              state.showScanner = false;
              state.showAddModal = true;
              render();
            }
            // Ignore errors - they happen while scanning
          });
          
        } catch (err) {
          console.error('Camera error:', err);
          showMessage('Camera access denied or not available', 'error');
          state.scannerActive = false;
        }
      }, 200);
    }

    function stopCameraScanner() {
      if (state.codeReader && state.scannerActive) {
        state.codeReader.reset();
        state.scannerActive = false;
        state.codeReader = null;
      }
    }

    function closeScannerModal() {
      stopCameraScanner();
      state.showScanner = false;
      render();
    }

    // API functions
    async function syncToSheets() {
      if (!state.sheetsUrl) {
        showMessage('Please configure Google Sheets URL in Settings first', 'error');
        return;
      }

      try {
        await fetch(state.sheetsUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'sync',
            items: state.items,
            sites: state.sites,
            rooms: state.rooms
          })
        });
        showMessage('Auto-synced to Google Sheets successfully!');
      } catch (error) {
        console.error('Sync error:', error);
        showMessage('Auto-sync failed. Will retry on next change.', 'error');
      }
    }

    async function loadFromSheets() {
      if (!state.sheetsUrl) {
        showMessage('Please configure Google Sheets URL in Settings first', 'error');
        return;
      }

      try {
        const response = await fetch(`${state.sheetsUrl}?action=load&timestamp=${Date.now()}`);
        const data = await response.json();
        
        if (data.items) state.items = data.items;
        if (data.sites) state.sites = data.sites;
        if (data.rooms) state.rooms = data.rooms;
        
        localStorage.setItem('techInventory', JSON.stringify(state.items));
        showMessage('Data loaded from Google Sheets successfully!');
        render();
      } catch (error) {
        console.error('Load error:', error);
        showMessage('Error loading from Google Sheets. Using local data.', 'error');
      }
    }

    // Item operations
    function addItem() {
      if (!state.formData.name || !state.formData.barcode) {
        showMessage('Please fill in name and barcode', 'error');
        return;
      }

      const now = new Date().toISOString();
      const location = `${state.formData.site} - ${state.formData.room}`;
      
      const newItem = {
        id: Date.now(),
        ...state.formData,
        location: location,
        dateAdded: now,
        lastModified: now
      };

      state.items.push(newItem);
      localStorage.setItem('techInventory', JSON.stringify(state.items));
      resetForm();
      state.showAddModal = false;
      syncToSheets();
      render();
    }

    function editItem() {
      if (!state.formData.name || !state.formData.barcode) {
        showMessage('Please fill in name and barcode', 'error');
        return;
      }

      const now = new Date().toISOString();
      const location = `${state.formData.site} - ${state.formData.room}`;
      
      state.items = state.items.map(item => 
        item.id === state.editingItem.id ? {
          ...item,
          ...state.formData,
          location: location,
          lastModified: now,
          dateAdded: item.dateAdded
        } : item
      );

      localStorage.setItem('techInventory', JSON.stringify(state.items));
      resetForm();
      state.editingItem = null;
      state.showAddModal = false;
      syncToSheets();
      render();
    }

    function deleteItem(id) {
      if (confirm('Are you sure you want to delete this item?')) {
        state.items = state.items.filter(item => item.id !== id);
        localStorage.setItem('techInventory', JSON.stringify(state.items));
        syncToSheets();
        render();
      }
    }

    function openEditModal(item) {
      const locationParts = item.location ? item.location.split(' - ') : ['', ''];
      const site = locationParts[0] || '';
      const room = locationParts.slice(1).join(' - ') || '';
      
      state.editingItem = item;
      state.formData = {
        name: item.name,
        barcode: item.barcode,
        category: item.category,
        site: site,
        room: room,
        status: item.status,
        assignedTo: item.assignedTo || '',
        purchaseDate: item.purchaseDate || ''
      };
      state.showAddModal = true;
      render();
    }

    function resetForm() {
      state.formData = {
        name: '',
        barcode: '',
        category: 'Desktop',
        site: '',
        room: '',
        status: 'Available',
        assignedTo: '',
        purchaseDate: ''
      };
    }

	    function saveSettings() {
	      localStorage.setItem('sheetsUrl', state.sheetsUrl);
	      localStorage.setItem('dellApiUrl', state.dellApiUrl); // Save the new API URL
	      showMessage('Settings saved successfully!');
	    }

    // Render functions
    function render() {
      const app = document.getElementById('app');
      const filteredItems = state.items.filter(item =>
        item.name.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
        item.barcode.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
        item.location.toLowerCase().includes(state.searchTerm.toLowerCase())
      );
      
      app.innerHTML = `
        <div class="max-w-7xl mx-auto p-4">
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
              <div class="flex items-center gap-3">
                <svg class="text-blue-600" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="3" y1="9" x2="21" y2="9"></line>
                  <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
                <h1 class="text-3xl font-bold text-gray-800">Technology Inventory</h1>
              </div>
              
              <div class="flex gap-2">
                <button onclick="changeView('inventory')" 
                  class="px-4 py-2 rounded-lg ${state.currentView === 'inventory' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}">
                  Inventory
                </button>
                <button onclick="loadFromSheets()" 
                  class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                  Load from Sheets
                </button>
                <button onclick="changeView('settings')" 
                  class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                  Settings
                </button>
              </div>
            </div>

            ${state.currentView === 'inventory' ? renderInventoryView(filteredItems) : renderSettingsView()}
          </div>
        </div>

        ${state.showScanner ? renderScannerModal() : ''}
        ${state.showAddModal ? renderAddModal() : ''}
      `;
    }

    function renderInventoryView(filteredItems) {
      return `
        <!-- Search and Actions -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="flex-1 relative">
	            <input type="text" 
	              placeholder="Search by name, barcode, or location..." 
	              value="${state.searchTerm}"
	              oninput="window.debouncedRender(this.value)"
	              class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          <button onclick="startCameraScanner()" 
            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
            Scan Barcode
          </button>
          <button onclick="resetForm(); state.editingItem = null; state.showAddModal = true; render();" 
            class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
            Add Item
          </button>
        </div>

        <!-- Inventory Table -->
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Barcode</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assigned To</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date Added</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Modified</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${filteredItems.map(item => `
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-4 text-sm font-medium text-gray-900">${item.name}</td>
                  <td class="px-4 py-4 text-sm text-gray-900">${item.barcode}</td>
                  <td class="px-4 py-4 text-sm text-gray-900">${item.category}</td>
                  <td class="px-4 py-4 text-sm text-gray-900">${item.location}</td>
                  <td class="px-4 py-4">
                    <span class="px-2 text-xs font-semibold rounded-full ${
                      item.status === 'Available' ? 'bg-green-100 text-green-800' :
                      item.status === 'In Use' ? 'bg-blue-100 text-blue-800' :
                      item.status === 'In Repair' ? 'bg-yellow-100 text-yellow-800' :
                      'bg-gray-100 text-gray-800'
                    }">
                      ${item.status}
                    </span>
                  </td>
                  <td class="px-4 py-4 text-sm text-gray-900">${item.assignedTo || '-'}</td>
                  <td class="px-4 py-4 text-sm text-gray-500">${formatDateTime(item.dateAdded)}</td>
                  <td class="px-4 py-4 text-sm text-gray-500">${formatDateTime(item.lastModified)}</td>
                  <td class="px-4 py-4 text-sm">
                    <button onclick='openEditModal(${JSON.stringify(item).replace(/'/g, "&apos;")})' 
                      class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                    <button onclick="deleteItem(${item.id})" 
                      class="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        ${filteredItems.length === 0 ? '<div class="text-center py-12 text-gray-500 text-lg">No items found</div>' : ''}
      `;
    }

    function renderSettingsView() {
      return `
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Settings</h2>
        
	        <div class="mb-8">
	          <h3 class="text-lg font-semibold text-gray-700 mb-3">Dell Lookup API Integration</h3>
	          <p class="text-sm text-gray-600 mb-3">Enter the URL for your deployed Dell Service Tag Lookup API (e.g., https://your-api.onrender.com).</p>
	          <input type="text" 
	            value="${state.dellApiUrl}"
	            oninput="state.dellApiUrl = this.value"
	            placeholder="https://your-api-url.com"
	            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-3">
	          <button onclick="saveSettings()" 
	            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
	            Save Settings
	          </button>
	        </div>

	        <div class="mb-8">
	          <h3 class="text-lg font-semibold text-gray-700 mb-3">Google Sheets Integration</h3>
          <p class="text-sm text-gray-600 mb-3">Enter your Google Apps Script Web App URL to sync data with Google Sheets.</p>
          <input type="text" 
            value="${state.sheetsUrl}"
            oninput="state.sheetsUrl = this.value"
            placeholder="https://script.google.com/macros/s/..."
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-3">
          <button onclick="saveSettings()" 
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
            Save Settings
          </button>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">📋 Managing Sites & Rooms</h3>
          <p class="text-sm text-gray-700 mb-2"><strong>Sites and Rooms are managed in Google Sheets!</strong></p>
          <ol class="text-sm text-gray-600 list-decimal list-inside space-y-1 ml-2">
            <li>Open your Google Sheet (the one connected to this app)</li>
            <li>Go to the "Sites" tab to manage school sites</li>
            <li>Go to the "Rooms" tab to manage room numbers</li>
            <li>Add or delete rows as needed</li>
            <li>Come back here and click "Load from Sheets" button</li>
          </ol>
        </div>
      `;
    }

    function renderScannerModal() {
      return `
        <div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
          <div class="bg-white p-6 rounded-lg max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold">Scan Barcode</h3>
              <button onclick="closeScannerModal()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
            </div>
            
            <!-- Camera Preview -->
            <div class="relative mb-4">
              <video id="video-preview" class="w-full rounded-lg border-2 border-blue-500" style="max-height: 400px;"></video>
              <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border-2 border-green-500 w-64 h-32 pointer-events-none"></div>
            </div>
            
            <p class="text-sm text-gray-600 text-center mb-4">
              Point camera at barcode or Dell service tag
            </p>
            
            <div class="border-t pt-4 mt-4">
              <p class="text-sm text-gray-600 mb-3 text-center">Or enter manually:</p>
              <input type="text" id="manualBarcodeInput" 
                placeholder="Type barcode here" 
                class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-3 text-center text-lg">
              <button onclick="
                const manualCode = document.getElementById('manualBarcodeInput').value.trim();
                if (manualCode) {
                  stopCameraScanner();
                  
		                  const tag = manualCode.toUpperCase();
		                  
		                  if (isValidDellServiceTag(tag)) {
		                    state.formData.barcode = tag;
		                    showMessage('Dell Service Tag entered: ' + tag);
		                    lookupDellModel(tag); // <-- New: Lookup Dell model
		                  } else if (isValidHPSerial(tag)) {
		                    state.formData.barcode = tag;
		                    showMessage('HP Serial Number entered: ' + tag);
		                    lookupHPModel(tag); // <-- New: Lookup HP model
		                  } else if (isValidViewSonicSerial(tag)) {
		                    state.formData.barcode = tag;
		                    showMessage('ViewSonic Serial Number entered: ' + tag);
		                    lookupViewSonicModel(tag); // <-- New: Lookup ViewSonic model
		                  } else if (isValidJuniperSerial(tag)) {
		                    state.formData.barcode = tag;
		                    showMessage('Juniper Serial Number entered: ' + tag);
		                    lookupJuniperModel(tag); // <-- New: Lookup Juniper model
} else if (isValidCyberPowerSerial(tag)) {
			                    state.formData.barcode = tag;
			                    showMessage('CyberPower Serial Number entered: ' + tag);
			                    lookupCyberPowerModel(tag); // <-- New: Lookup CyberPower model
			                  } else if (isValidBrotherSerial(tag)) {
			                    state.formData.barcode = tag;
			                    showMessage('Brother Serial Number entered: ' + tag);
			                    lookupBrotherModel(tag); // <-- New: Lookup Brother model
			                  } else if (isValidAppleSerial(tag)) {
			                    state.formData.barcode = tag;
			                    showMessage('Apple Serial Number entered: ' + tag);
			                    lookupAppleModel(tag); // <-- New: Lookup Apple model
			                  } else if (isValidAcerSerial(tag)) {
			                    state.formData.barcode = tag;
			                    showMessage('Acer Serial Number/SNID entered: ' + tag);
			                    lookupAcerModel(tag); // <-- New: Lookup Acer model
			                  } else {
	                    state.formData.barcode = manualCode;
	                    showMessage('Barcode entered successfully!');
	                  }

                  state.showScanner = false;
                  state.showAddModal = true;
                  render();
                } else {
                  showMessage('Please enter a barcode or service tag', 'error');
                }
              " class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                Use Manual Entry
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderAddModal() {
      const filteredRooms = getFilteredRooms();
      
      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div class="bg-white p-6 rounded-lg max-w-2xl w-full m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold">${state.editingItem ? 'Edit Item' : 'Add New Item'}</h3>
              <button onclick="state.showAddModal = false; state.editingItem = null; resetForm(); render();" 
                class="text-gray-500 hover:text-gray-700">✕</button>
            </div>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                <input type="text" value="${state.formData.name}" 
                  oninput="state.formData.name = this.value"
                  placeholder="e.g., Dell Latitude 5420"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Barcode</label>
                <input type="text" value="${state.formData.barcode}" 
                  oninput="state.formData.barcode = this.value"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select onchange="state.formData.category = this.value" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  ${categories.map(cat => 
                    `<option value="${cat}" ${state.formData.category === cat ? 'selected' : ''}>${cat}</option>`
                  ).join('')}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Site</label>
                <select onchange="state.formData.site = this.value; state.formData.room = ''; render();" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="">Select Site</option>
                  ${state.sites.map(site => 
                    `<option value="${site}" ${state.formData.site === site ? 'selected' : ''}>${site}</option>`
                  ).join('')}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Room</label>
                <div class="flex items-center gap-2 mb-2 bg-blue-50 p-2 rounded">
                  <input type="checkbox" id="classroomFilter" 
                    ${state.showClassroomsOnly ? 'checked' : ''}
                    onchange="state.showClassroomsOnly = this.checked; render();">
                  <label for="classroomFilter" class="text-sm text-gray-700">
                    Show classrooms only (hide storage, mechanical, restrooms, etc.)
                  </label>
                </div>
                <select onchange="state.formData.room = this.value" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg" 
                  ${!state.formData.site ? 'disabled' : ''}>
                  <option value="">${state.formData.site ? 'Select Room' : 'Select Site First'}</option>
                  ${filteredRooms.map(room => 
                    `<option value="${room}" ${state.formData.room === room ? 'selected' : ''}>${room}</option>`
                  ).join('')}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select onchange="state.formData.status = this.value" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  ${statuses.map(status => 
                    `<option value="${status}" ${state.formData.status === status ? 'selected' : ''}>${status}</option>`
                  ).join('')}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Assigned To (Optional)</label>
                <input type="text" value="${state.formData.assignedTo}" 
                  oninput="state.formData.assignedTo = this.value"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Purchase Date (Optional)</label>
                <input type="date" value="${state.formData.purchaseDate}" 
                  oninput="state.formData.purchaseDate = this.value"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>

              <div class="flex gap-3">
                <button onclick="state.showAddModal = false; state.editingItem = null; resetForm(); render();" 
                  class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                  Cancel
                </button>
                <button onclick="${state.editingItem ? 'editItem()' : 'addItem()'}" 
                  class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                  ${state.editingItem ? 'Save Changes' : 'Add Item'}
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function changeView(view) {
      state.currentView = view;
      render();
    }

    // Load saved URL and data on startup
    if (state.sheetsUrl) {
      loadFromSheets();
    }

    // Initial render
    render();

    // Debounce the render function for search input
    const debouncedRender = debounce((value) => {
      state.searchTerm = value;
      render();
    }, 300);

    // Expose necessary functions to the global scope for HTML event handlers
    window.changeView = changeView;
    window.loadFromSheets = loadFromSheets;
    window.startCameraScanner = startCameraScanner;
    window.resetForm = resetForm;
    window.render = render;
    window.debouncedRender = debouncedRender;
    window.openEditModal = openEditModal;
    window.deleteItem = deleteItem;
    window.saveSettings = saveSettings;
    window.closeScannerModal = closeScannerModal;
    window.addItem = addItem;
    window.editItem = editItem;
    window.isValidDellServiceTag = isValidDellServiceTag; // Exposed for manual entry logic
    window.isValidHPSerial = isValidHPSerial; // Exposed for manual entry logic
    window.isValidViewSonicSerial = isValidViewSonicSerial; // Exposed for manual entry logic
    window.isValidJuniperSerial = isValidJuniperSerial; // Exposed for manual entry logic
    window.isValidCyberPowerSerial = isValidCyberPowerSerial; // Exposed for manual entry logic
    window.isValidBrotherSerial = isValidBrotherSerial; // Exposed for manual entry logic
    window.isValidAppleSerial = isValidAppleSerial; // Exposed for manual entry logic
    window.isValidAcerSerial = isValidAcerSerial; // Exposed for manual entry logic
    window.isValidSamsungSerial = isValidSamsungSerial; // Exposed for manual entry logic
    window.isValidVizioSerial = isValidVizioSerial; // Exposed for manual entry logic
    window.isValidTCLSerial = isValidTCLSerial; // Exposed for manual entry logic

    })();
  </script>
</body>
</html>
